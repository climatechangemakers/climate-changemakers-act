services:
  - docker:dind

variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

stages: 
  - test
  - build

before_script: 
  - export GRADLE_USER_HOME=`pwd`/backend/.gradle

cache:
  paths:
    - ./bakcned/.gradle/wrapper
    - ./backend/.gradle/caches

test-backend:
  image: openjdk:11.0.12
  stage: test
  script: 
    - cd backend
    - ./gradlew test
  only: 
    - trunk 
    - external_pull_requests

build-production-container:
  image: docker:stable
  stage: build
  script: 
    - docker build -t $IMAGE_TAG:$(git rev-parse --short HEAD) .
  only: 
    - external_pull_requests

publish-production-container:
  image: docker:stable
  stage: build
  script: 
    - docker login -u $GITLAB_USER_LOGIN -p $GITLAB_API_KEY registry.gitlab.com 
    - docker build -t $IMAGE_TAG:$(git rev-parse --short HEAD) .
    - docker push $IMAGE_TAG
  only: 
    - trunk
