services:
  - docker:dind

variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

stages: 
  - test
  - build

    # before_script: 
    #   - export GRADLE_USER_HOME=`pwd`/backend/.gradle
    # 
    # cache:
    #   paths:
    #     - ./bakcned/.gradle/wrapper
    #     - ./backend/.gradle/caches
    # 
    # test-backend:
    #   image: openjdk:11.0.12
    #   stage: test
    #   script: 
    #     - cd backend
    #     - ./gradlew test
    #   only: 
    #     - trunk 
    #     - external_pull_requests
    # 
    # build-production-container:
    #   image: docker:stable
    #   stage: build
    #   script: 
    #     - docker build $IMAGE_TAG .
    #   only: 
    #     - external_pull_requests

publish-production-container:
  image: docker:stable
  stage: build
  script: 
    - echo $CI_DEPLOY_USER
    - echo $CI_DEPLOY_PASSWORD
    - echo $CI_DEPLOY_REGISTRY
    - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
  only: 
    - trunk
    # TODO(kcianfarini) remove just for testing
    - external_pull_requests
